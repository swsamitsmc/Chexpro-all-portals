name: Deploy to OCI (Secure)

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Install OCI CLI (Uses your NEW secrets)
      - name: Install OCI CLI
        uses: oracle-actions/setup-oci-cli@v1.2.1
        with:
          user: ${{ secrets.OCI_CLI_USER }}
          fingerprint: ${{ secrets.OCI_CLI_FINGERPRINT }}
          key_file: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          tenancy: ${{ secrets.OCI_CLI_TENANCY }}
          region: ${{ secrets.OCI_CLI_REGION }}

      # 2. Get Runner IP and Whitelist it in OCI (Uses your NEW secrets)
      - name: Whitelist Runner IP
        id: whitelist
        run: |
          # Get current public IP of the GitHub runner
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Whitelisting IP: $RUNNER_IP"
          
          # Add Security Rule to NSG (Port 22, TCP)
          oci network nsg rules add \
            --nsg-id ${{ secrets.OCI_NSG_OCID }} \
            --direction INGRESS \
            --protocol 6 \
            --source $RUNNER_IP/32 \
            --tcp-port-range 22:22 \
            --description "Temp GitHub Action Access"

          # Save IP to output so we can remove it later
          echo "runner_ip=$RUNNER_IP" >> $GITHUB_OUTPUT

      # 3. Deploy to Server (Uses your OLD SSH secrets)
      - name: Deploy to OCI Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OCI_SSH_HOST }}
          username: ${{ secrets.OCI_SSH_USER }}
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "### 1. Navigating to build directory ###"
            mkdir -p /var/www/chexpro-frontend-build
            cd /var/www/chexpro-frontend-build
            
            # Avoid host key verification errors
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts
            git reset --hard origin/master
            git pull origin master

            echo "### 2. Building frontend ###"
            GIT_HASH=$(git rev-parse --short HEAD)
            cd frontend
            # FIX: Use legacy-peer-deps for React 19 conflict
            npm install --legacy-peer-deps
            npm run build

            # Timestamp injection
            if [ -f dist/index.html ]; then
              sed -i "s#</body>#</body>|" dist/index.html
            fi

            echo "### 3. Deploying files ###"
            # FIX: Removed 'sudo'. Permissions must be correct on server.
            rsync -av --delete --exclude '.env' dist/ /var/www/chexpro-frontend/
            
            cd ../server
            rsync -av --delete --exclude '.env' --exclude 'node_modules/' . /var/www/chexpro-backend/

            echo "### 4. Restarting Backend ###"
            cd /var/www/chexpro-backend
            npm install --production
            pm2 reload chexpro-backend --update-env
            pm2 status

      # 4. Revoke Access (Runs even if deployment fails)
      - name: Revoke Runner IP
        if: always()
        run: |
          RUNNER_IP=${{ steps.whitelist.outputs.runner_ip }}
          echo "Revoking access for IP: $RUNNER_IP"
          
          # Find the specific rule ID for this runner's IP
          RULE_ID=$(oci network nsg rules list --nsg-id ${{ secrets.OCI_NSG_OCID }} --all | jq -r --arg ip "$RUNNER_IP/32" '.data[] | select(.source==$ip and .description=="Temp GitHub Action Access") | .id')
          
          if [ ! -z "$RULE_ID" ]; then
            oci network nsg rules remove --nsg-id ${{ secrets.OCI_NSG_OCID }} --security-rule-ids "[\"$RULE_ID\"]" --force
            echo "Access revoked."
          else
            echo "Rule not found or already removed."
          fi
